<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="漏洞成因该漏洞形成，是因为在处理用户输入的时候，进行了二次解析，所以导致了OGNL表达式注入，影响版本 Struts 2.0.0 - Struts 2.5.20。 漏洞需要开启 Alt Syntax（默认开启），并且只能在 id 属性中触发。 1The altSyntax is an option that can be defined in struts.properties. By defau">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2019-0230 S2-059">
<meta property="og:url" content="http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/index.html">
<meta property="og:site_name" content="学习记录">
<meta property="og:description" content="漏洞成因该漏洞形成，是因为在处理用户输入的时候，进行了二次解析，所以导致了OGNL表达式注入，影响版本 Struts 2.0.0 - Struts 2.5.20。 漏洞需要开启 Alt Syntax（默认开启），并且只能在 id 属性中触发。 1The altSyntax is an option that can be defined in struts.properties. By defau">
<meta property="og:locale">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602767848556-7ck.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602768117136-0ju.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602769072346-iiz.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602920428711-ybe.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602921014034-igw.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602921347433-cro.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602921478668-lbk.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602920598241-xmi.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602922073408-vkx.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602922125088-mpb.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602922268348-znh.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602922347430-wij.png">
<meta property="og:image" content="http://yoursite.com/img/s2-059/1602922447994-kfy.png">
<meta property="article:published_time" content="2020-10-17T16:31:49.000Z">
<meta property="article:modified_time" content="2020-10-17T16:54:57.338Z">
<meta property="article:author" content="lex">
<meta property="article:tag" content="CVE">
<meta property="article:tag" content="RCE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/img/s2-059/1602767848556-7ck.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>CVE-2019-0230 S2-059</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/POC/">POC</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/11/19/CVE-2020-16875/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/10/10/Struts2-s2-057/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&text=CVE-2019-0230 S2-059"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&is_video=false&description=CVE-2019-0230 S2-059"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2019-0230 S2-059&body=Check out this article: http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&name=CVE-2019-0230 S2-059&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&t=CVE-2019-0230 S2-059"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">1.</span> <span class="toc-text">漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">4.</span> <span class="toc-text">参考文档</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2019-0230 S2-059
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">学习记录</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-10-17T16:31:49.000Z" itemprop="datePublished">2020-10-18</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/CVE/" rel="tag">CVE</a>, <a class="tag-link-link" href="/tags/RCE/" rel="tag">RCE</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h3><p>该漏洞形成，是因为在处理用户输入的时候，进行了二次解析，所以导致了OGNL表达式注入，影响版本 Struts 2.0.0 - Struts 2.5.20。</p>
<p>漏洞需要开启 Alt Syntax（默认开启），并且只能在 id 属性中触发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The altSyntax is an option that can be defined in struts.properties. By default it is set to true and it is strongly recommend you do not change that unless you are upgrading from WebWork 2.1.7 or previous versions.</span><br></pre></td></tr></table></figure>

<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>下载 <code>https://archive.apache.org/dist/struts/2.5.16/struts-2.5.16-min-lib.zip</code></p>
<p>使用IDEA创建一个Struts2项目</p>
<p><img src="/img/s2-059/1602767848556-7ck.png" alt="1602767848556-7ck.png"></p>
<p>这里选择 Set up library later<br>创建好后，在IDEA的WEB-INF目录下创建一个lib文件夹，并且把下载好的 struts-2.5.16-min-lib.zip 里面的 jar 包解压到lib目录下<br>然后还需要一个log4j-core.jar，根据版本信息下载对应的 Jar 包放到 lib 目录下，接着右键点击 Add as Library<br>还要设置<code>Facets</code>，<code>Struts.xml</code>和<code>struts-default.xml</code>必须放到同一个<code>facets</code>下，不然会出错</p>
<p><img src="/img/s2-059/1602768117136-0ju.png" alt="1602768117136-0ju.png"></p>
<p>在 2.5 的版本，<code>web.xml</code> 的设置如下，idea默认生成的是低版本的配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;web-app xmlns&#x3D;&quot;http:&#x2F;&#x2F;xmlns.jcp.org&#x2F;xml&#x2F;ns&#x2F;javaee&quot;</span><br><span class="line">         xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;xmlns.jcp.org&#x2F;xml&#x2F;ns&#x2F;javaee http:&#x2F;&#x2F;xmlns.jcp.org&#x2F;xml&#x2F;ns&#x2F;javaee&#x2F;web-app_4_0.xsd&quot;</span><br><span class="line">         version&#x3D;&quot;4.0&quot;&gt;</span><br><span class="line">    &lt;filter&gt;</span><br><span class="line">        &lt;filter-name&gt;struts2&lt;&#x2F;filter-name&gt;</span><br><span class="line">        &lt;filter-class&gt;org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter&lt;&#x2F;filter-class&gt;</span><br><span class="line">    &lt;&#x2F;filter&gt;</span><br><span class="line">    &lt;filter-mapping&gt;</span><br><span class="line">        &lt;filter-name&gt;struts2&lt;&#x2F;filter-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;&#x2F;*&lt;&#x2F;url-pattern&gt;</span><br><span class="line">    &lt;&#x2F;filter-mapping&gt;</span><br><span class="line">&lt;&#x2F;web-app&gt;</span><br></pre></td></tr></table></figure>

<p>设置好 <code>web.xml</code>，创建一个<code>package</code></p>
<p><img src="/img/s2-059/1602769072346-iiz.png" alt="1602769072346-iiz.png"></p>
<p>对应代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.s2059.vuln;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.bcel.internal.generic.ATHROW;</span><br><span class="line"></span><br><span class="line">public class VulnAction &#123;</span><br><span class="line">    private String skillName &#x3D; null;</span><br><span class="line">    private String SUCCESS &#x3D; &quot;success&quot;;</span><br><span class="line"></span><br><span class="line">    public String getSkillName() &#123;</span><br><span class="line">        return skillName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setSkillName(String skillName) &#123;</span><br><span class="line">        this.skillName &#x3D; skillName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String execute() throws Exception &#123;</span><br><span class="line">        return SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在 <code>struts2.xml</code> 中设置对应的action</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE struts PUBLIC</span><br><span class="line">        &quot;-&#x2F;&#x2F;Apache Software Foundation&#x2F;&#x2F;DTD Struts Configuration 2.0&#x2F;&#x2F;EN&quot;</span><br><span class="line">        &quot;http:&#x2F;&#x2F;struts.apache.org&#x2F;dtds&#x2F;struts-2.0.dtd&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;struts&gt;</span><br><span class="line">    &lt;package name&#x3D;&quot;poctest&quot; extends&#x3D;&quot;struts-default&quot; namespace&#x3D;&quot;&#x2F;&quot;&gt;</span><br><span class="line">        &lt;action name&#x3D;&quot;vuln&quot; class&#x3D;&quot;com.s2059.vuln.VulnAction&quot; method&#x3D;&quot;execute&quot;&gt;</span><br><span class="line">            &lt;result name&#x3D;&quot;success&quot;&gt;&#x2F;vuln.jsp&lt;&#x2F;result&gt;</span><br><span class="line">        &lt;&#x2F;action&gt;</span><br><span class="line">    &lt;&#x2F;package&gt;</span><br><span class="line">&lt;&#x2F;struts&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建<code>vuln.jsp</code>，漏洞只在 <code>a</code> 标签 <code>id</code> 属性中触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: lex</span><br><span class="line">  Date: 10&#x2F;15&#x2F;20</span><br><span class="line">  Time: 4:39 AM</span><br><span class="line">  To change this template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType&#x3D;&quot;text&#x2F;html;charset&#x3D;UTF-8&quot; language&#x3D;&quot;java&quot; %&gt;</span><br><span class="line">&lt;%@ page import&#x3D;&quot;java.util.*&quot; pageEncoding&#x3D;&quot;UTF-8&quot; %&gt;</span><br><span class="line">&lt;%@ taglib prefix&#x3D;&quot;s&quot; uri&#x3D;&quot;&#x2F;struts-tags&quot; %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;s2-059&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;s:a id&#x3D;&quot;%&#123;skillName&#125;&quot;&gt;s2-059 test&lt;&#x2F;s:a&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>打开后访问 <code>http://localhost:8080/s2_059_war_exploded/vuln?skillName=s</code></p>
<p>从IDEA的输出窗口中可以看到如下信息：从IDEA的输出窗口中可以看到如下信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">16-Oct-2020 05:43:40.778 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 298 read class attr -- &#39;setParent&#39;</span><br><span class="line">16-Oct-2020 05:43:40.778 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 299 read class attr -- &#39;(Ljavax&#x2F;servlet&#x2F;jsp&#x2F;tagext&#x2F;Tag;)V&#39;</span><br><span class="line">16-Oct-2020 05:43:40.778 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 300 copying 2 bytes</span><br><span class="line">16-Oct-2020 05:43:40.778 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 301 read class attr -- &#39;%&#123;skillName&#125;&#39;</span><br><span class="line">16-Oct-2020 05:43:40.778 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 302 copying 4 bytes</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 303 copying 4 bytes</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 304 read class attr -- &#39;setId&#39;</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 305 copying 4 bytes</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 306 copying 4 bytes</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 307 read class attr -- &#39;doStartTag&#39;</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 308 copying 4 bytes</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 309 copying 2 bytes</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 310 read class attr -- &#39;org&#x2F;apache&#x2F;jasper&#x2F;runtime&#x2F;JspRuntimeLibrary&#39;</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 311 copying 4 bytes</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 312 read class attr -- &#39;startBufferedBody&#39;</span><br><span class="line">16-Oct-2020 05:43:40.779 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 313 read class attr -- &#39;(Ljavax&#x2F;servlet&#x2F;jsp&#x2F;PageContext;Ljavax&#x2F;servlet&#x2F;jsp&#x2F;tagext&#x2F;BodyTag;)Ljavax&#x2F;servlet&#x2F;jsp&#x2F;JspWriter;&#39;</span><br><span class="line">16-Oct-2020 05:43:40.780 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 314 copying 2 bytes</span><br><span class="line">16-Oct-2020 05:43:40.780 FINE [http-nio-8080-exec-4] org.apache.jasper.compiler.SmapUtil$SDEInstaller.copyConstantPool 315 read class attr -- &#39;payload test&#39;</span><br></pre></td></tr></table></figure>

<p>从上面可以看到，在 <code>SetId</code> 之后使用了 <code>doStartTag</code> 函数做处理，然后在 <code>struts2</code> 里面找到这个方法，并且下断点，方法在 <code>org.apache.struts2.views.jsp.ComponentTagSupport</code> 里面定义了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public int doStartTag() throws JspException &#123;</span><br><span class="line">    ValueStack stack &#x3D; this.getStack();</span><br><span class="line">    this.component &#x3D; this.getBean(stack, (HttpServletRequest)this.pageContext.getRequest(), (HttpServletResponse)this.pageContext.getResponse());</span><br><span class="line">    Container container &#x3D; (Container)stack.getContext().get(&quot;com.opensymphony.xwork2.ActionContext.container&quot;);</span><br><span class="line">    container.inject(this.component);</span><br><span class="line">    this.populateParams();</span><br><span class="line">    boolean evalBody &#x3D; this.component.start(this.pageContext.getOut());</span><br><span class="line">    if (evalBody) &#123;</span><br><span class="line">        return this.component.usesBody() ? 2 : 1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着到IDEA中查看</p>
<p><img src="/img/s2-059/1602920428711-ybe.png" alt="1602920428711-ybe.png"></p>
<p>该函数调用了父类的 <code>populateParams()</code>，在内部对 id 进行了赋值</p>
<p><img src="/img/s2-059/1602921014034-igw.png" alt="1602921014034-igw.png"></p>
<p>跟进 <code>setId()</code> 函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void setId(String id) &#123;</span><br><span class="line">    if (id !&#x3D; null) &#123;</span><br><span class="line">        this.id &#x3D; this.findString(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了 <code>this.findString()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protected String findString(String expr) &#123;</span><br><span class="line">    return (String)this.findValue(expr, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进 <code>this.findValue()</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">protected Object findValue(String expr, Class toType) &#123;</span><br><span class="line">    if (this.altSyntax() &amp;&amp; toType &#x3D;&#x3D; String.class) &#123;</span><br><span class="line">        return ComponentUtils.containsExpression(expr) ? TextParseUtil.translateVariables(&#39;%&#39;, expr, this.stack) : expr;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        expr &#x3D; this.stripExpressionIfAltSyntax(expr);</span><br><span class="line">        return this.getStack().findValue(expr, toType, this.throwExceptionOnELFailure);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里对 <em>this.altSyntax()</em> 和 <code>toType</code> 进行了与操作，判断通过才可以通过，接着跟进 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return ComponentUtils.containsExpression(expr) ? TextParseUtil.translateVariables(&#39;%&#39;, expr, this.stack) : expr;</span><br></pre></td></tr></table></figure>

<p><img src="/img/s2-059/1602921347433-cro.png" alt="1602921347433-cro.png"></p>
<p>这里判断 <code>expr</code> 是否包含了 <code>&quot;%&#123;&#125;&quot;</code>，返回 True，所以接着就调用了 <code>TextParseUtil.translateVariables(&#39;%&#39;, expr, this.stack)</code></p>
<p><img src="/img/s2-059/1602921478668-lbk.png" alt="1602921478668-lbk.png"></p>
<p>该函数的作用是对属性值做赋值操作，接着进入 <code>this.componment.start()</code> 函数，可以看到，此时 <code>id</code> 的值已经为 <code>s</code></p>
<p><img src="/img/s2-059/1602920598241-xmi.png" alt="1602920598241-xmi.png"></p>
<p>跟进 <code>start</code> 方法，最后调用到了 <code>ClosingUIBean.start</code> 方法，此时 <code>result = true</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public boolean start(Writer writer) &#123;</span><br><span class="line">    boolean result &#x3D; super.start(writer);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        this.evaluateParams();</span><br><span class="line">        this.mergeTemplate(writer, this.buildTemplateName(this.openTemplate, this.getDefaultOpenTemplate()));</span><br><span class="line">    &#125; catch (Exception var4) &#123;</span><br><span class="line">        LOG.error(&quot;Could not open template&quot;, var4);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进 <code>this.evaluateParams()</code> ，实际调用了<code>UIBean.evaluateParams()</code>，函数内调用了 <code>this.populateCOmponentHtmlId(form)</code></p>
<p><img src="/img/s2-059/1602922073408-vkx.png" alt="1602922073408-vkx.png"></p>
<p>跟进 <code>this.populateCOmponentHtmlId</code>，此时 <code>id=s</code></p>
<p><img src="/img/s2-059/1602922125088-mpb.png" alt="1602922125088-mpb.png"></p>
<p>进入函数 <code>this.findStringIfAltSyntax()</code></p>
<p><img src="/img/s2-059/1602922268348-znh.png" alt="1602922268348-znh.png"></p>
<p>因为 <code>this.altSyntax()</code> 返回 <code>true</code>， 所以此时调用了 <code>this.findString(expr)</code>，进入 <code>this.findString()</code></p>
<p><img src="/img/s2-059/1602922347430-wij.png" alt="1602922347430-wij.png"></p>
<p>进入 <code>findValue()</code></p>
<p><img src="/img/s2-059/1602922447994-kfy.png" alt="1602922447994-kfy.png"></p>
<p>可以看到，此时再次执行了 <code>TextParseUtil.translateVariables()</code> 函数，造成二次解析，所以导致了OGNL注入</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1302/">https://paper.seebug.org/1302/</a></p>
<p><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/WW/S2-059">https://cwiki.apache.org/confluence/display/WW/S2-059</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/POC/">POC</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">1.</span> <span class="toc-text">漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">4.</span> <span class="toc-text">参考文档</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&text=CVE-2019-0230 S2-059"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&is_video=false&description=CVE-2019-0230 S2-059"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2019-0230 S2-059&body=Check out this article: http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&title=CVE-2019-0230 S2-059"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&name=CVE-2019-0230 S2-059&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yoursite.com/2020/10/18/CVE-2019-0230-S2-059/&t=CVE-2019-0230 S2-059"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2021
    lex
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/POC/">POC</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
